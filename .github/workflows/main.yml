name: Deploy App

on:
  workflow_run:
    workflows: ["Retry Deployment on Failure"]
    types:
      - completed

jobs:
  step-1:
    name: 'Step 1'
    runs-on: ubuntu@latest
    steps:
      - name: echo someting
        run: echo "ECHO 1"

  deploy:
    name: 'Step 2 - Failure'
    runs-on: ubuntu@latest
    needs: [step-1]
    steps:
      - name: fail job
        run: exit 1

  step-3-retry:
    needs: [deploy]
    name: 'Step 3 - Retry'
    runs-on: ubuntu@latest
    if: ${{ always() }}
    steps:
      - name: Fail if deploy failed
        run: |
          if [[ "${{ needs.deploy.result }}" != "success" ]]; then
            echo "Deployment failed, retrying..."
            exit 1
          fi
